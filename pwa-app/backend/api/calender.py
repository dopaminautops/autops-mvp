from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from models.database import get_db, Booking, CalendarEvent
from services.google_calendar import GoogleCalendarService
from datetime import datetime, timedelta

router = APIRouter()
calendar_service = GoogleCalendarService()

@router.post("/create/{booking_id}")
async def create_calendar_event(
    booking_id: int,
        db: Session = Depends(get_db)
        ):
            """
                Create a Google Calendar event for a booking
                    Matches your "Calendar & Auto-Booking" screen
                        """
                            booking = db.query(Booking).filter(Booking.id == booking_id).first()
                                
                                    if not booking:
                                            raise HTTPException(status_code=404, detail="Booking not found")
                                                
                                                    # Check if calendar event already exists
                                                        existing_event = db.query(CalendarEvent).filter(
                                                                CalendarEvent.booking_id == booking_id
                                                                    ).first()
                                                                        
                                                                            if existing_event:
                                                                                    return {
                                                                                                "success": True,
                                                                                                            "message": "Calendar event already exists",
                                                                                                                        "event_id": existing_event.event_id,
                                                                                                                                    "calendar_link": existing_event.calendar_link
                                                                                                                                            }
                                                                                                                                                
                                                                                                                                                    try:
                                                                                                                                                            # Create calendar event
                                                                                                                                                                    event = await calendar_service.create_event(
                                                                                                                                                                                customer_name=booking.customer_name,
                                                                                                                                                                                            service_type=booking.service_type,
                                                                                                                                                                                                        booking_date=booking.booking_date
                                                                                                                                                                                                                )
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                # Save to database
                                                                                                                                                                                                                                        calendar_event = CalendarEvent(
                                                                                                                                                                                                                                                    booking_id=booking.id,
                                                                                                                                                                                                                                                                event_id=event['id'],
                                                                                                                                                                                                                                                                            calendar_link=event['htmlLink']
                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                            db.add(calendar_event)
                                                                                                                                                                                                                                                                                                    db.commit()
                                                                                                                                                                                                                                                                                                            db.refresh(calendar_event)
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                        "success": True,
                                                                                                                                                                                                                                                                                                                                                    "event_id": calendar_event.event_id,
                                                                                                                                                                                                                                                                                                                                                                "calendar_link": calendar_event.calendar_link,
                                                                                                                                                                                                                                                                                                                                                                            "booking_date": booking.booking_date.isoformat()
                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                raise HTTPException(status_code=500, detail=str(e))

                                                                                                                                                                                                                                                                                                                                                                                                @router.get("/available-slots")
                                                                                                                                                                                                                                                                                                                                                                                                async def get_available_slots(
                                                                                                                                                                                                                                                                                                                                                                                                    date: str  # Format: YYYY-MM-DD
                                                                                                                                                                                                                                                                                                                                                                                                    ):
                                                                                                                                                                                                                                                                                                                                                                                                        """
                                                                                                                                                                                                                                                                                                                                                                                                            Get available time slots for a specific date
                                                                                                                                                                                                                                                                                                                                                                                                                For your "Available Time Slots" calendar view
                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                # Parse date
                                                                                                                                                                                                                                                                                                                                                                                                                                        target_date = datetime.strptime(date, "%Y-%m-%d")
                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Get available slots from Google Calendar
                                                                                                                                                                                                                                                                                                                                                                                                                                                                slots = await calendar_service.get_available_slots(target_date)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "date": date,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "slots": slots
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except ValueError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise HTTPException(status_code=400, detail="Invalid date format. Use YYYY-MM-DD")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        raise HTTPException(status_code=500, detail=str(e))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @router.get("/events/{booking_id}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def get_calendar_event(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            booking_id: int,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Get calendar event details for a booking
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                calendar_event = db.query(CalendarEvent).filter(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        CalendarEvent.booking_id == booking_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not calendar_event:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise HTTPException(status_code=404, detail="Calendar event not found")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    booking = db.query(Booking).filter(Booking.id == booking_id).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "event_id": calendar_event.event_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "calendar_link": calendar_event.calendar_link,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "created_at": calendar_event.created_at.isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "booking": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "customer_name": booking.customer_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "service_type": booking.service_type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "booking_date": booking.booking_date.isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @router.delete("/{booking_id}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async def delete_calendar_event(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                booking_id: int,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Delete a calendar event (for cancellations)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    calendar_event = db.query(CalendarEvent).filter(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            CalendarEvent.booking_id == booking_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not calendar_event:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                raise HTTPException(status_code=404, detail="Calendar event not found")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Delete from Google Calendar
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # (Implementation depends on your Google Calendar service)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Delete from database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.delete(calendar_event)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "success": True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "message": "Calendar event deleted"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    raise HTTPException(status_code=500, detail=str(e))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    @router.get("/upcoming")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async def get_upcoming_events(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        days: int = 7,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Get upcoming calendar events for the next X days
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        For your calendar dashboard view
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                start_date = datetime.utcnow()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    end_date = start_date + timedelta(days=days)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Get bookings with calendar events in date range
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                bookings = db.query(Booking).filter(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Booking.booking_date >= start_date,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Booking.booking_date <= end_date,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Booking.status == "confirmed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ).order_by(Booking.booking_date).all()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    events = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for booking in bookings:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                calendar_event = db.query(CalendarEvent).filter(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            CalendarEvent.booking_id == booking.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ).first()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if calendar_event:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                events.append({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "booking_id": booking.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "customer_name": booking.customer_name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "service_type": booking.service_type,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "booking_date": booking.booking_date.isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "calendar_link": calendar_event.calendar_link,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "event_id": calendar_event.event_id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "events": events,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "count": len(events),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "date_range": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "start": start_date.isoformat(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "end": end_date.isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }