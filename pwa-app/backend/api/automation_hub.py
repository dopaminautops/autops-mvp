from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from models.database import get_db, Workflow, WorkflowExecution, AISuggestion, ActivityLog
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime, timedelta

router = APIRouter()

# ============ PYDANTIC MODELS ============

class WorkflowCreate(BaseModel):
    name: str
        description: str
            trigger: str
                action: str
                    icon: str

                    class WorkflowUpdate(BaseModel):
                        is_active: bool
                        class AISuggestionCreate(BaseModel):
                                title: str
                                    description: str
                                        icon: str
                                            category: str
                                                priority: int

                                                class ActivityLogCreate(BaseModel):
                                                    icon: str
                                                        title: str
                                                            description: str
                                                                category: str

                                                                # ============ AI SUGGESTIONS ENDPOINTS ============

                                                                @router.get("/ai-suggestions")
                                                                async def get_ai_suggestions(
                                                                    limit: int = 10,
                                                                        db: Session = Depends(get_db)
                                                                        ):
                                                                            """
                                                                                Get AI-powered automation suggestions
                                                                                    For the "AI Suggestions" section
                                                                                        """
                                                                                            suggestions = db.query(AISuggestion).filter(
                                                                                                    AISuggestion.is_implemented == False
                                                                                                        ).order_by(
                                                                                                                AISuggestion.priority.desc()
                                                                                                                    ).limit(limit).all()
                                                                                                                        
                                                                                                                            return {
                                                                                                                                    "suggestions": [
                                                                                                                                                {
                                                                                                                                                                "id": s.id,
                                                                                                                                                                                "title": s.title,
                                                                                                                                                                                                "description": s.description,
                                                                                                                                                                                                                "icon": s.icon,
                                                                                                                                                                                                                                "category": s.category,
                                                                                                                                                                                                                                                "priority": s.priority
                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                        for s in suggestions
                                                                                                                                                                                                                                                                                ]
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                          @router.post("/ai-suggestions")
                                                                                                                                                                                                                                                                          async def create_ai_suggestion(
                                                                                                                                                                                                                                                                              suggestion: AISuggestionCreate,
                                                                                                                                                                                                                                                                                  db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                  ):
                                                                                                                                                                                                                                                                                      """
                                                                                                                                                                                                                                                                                          Create a new AI suggestion (for testing/admin)
                                                                                                                                                                                                                                                                                              """
                                                                                                                                                                                                                                                                                                  new_suggestion = AISuggestion(
                                                                                                                                                                                                                                                                                                          title=suggestion.title,
                                                                                                                                                                                                                                                                                                                  description=suggestion.description,
                                                                                                                                                                                                                                                                                                                          icon=suggestion.icon,
                                                                                                                                                                                                                                                                                                                                  category=suggestion.category,
                                                                                                                                                                                                                                                                                                                                          priority=suggestion.priority
                                                                                                                                                                                                                                                                                                                                              )
                                                                                                                                                                                                                                                                                                                                                  db.add(new_suggestion)
                                                                                                                                                                                                                                                                                                                                                      db.commit()
                                                                                                                                                                                                                                                                                                                                                          db.refresh(new_suggestion)

                                                                                                                                                                                                                                                                                                                                                                  return {
                                                                                                                                                                                                                                                                                                                                                                          "success": True,
                                                                                                                                                                                                                                                                                                                                                                                  "suggestion_id": new_suggestion.id
                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                      @router.post("/ai-suggestions/{suggestion_id}/implement")
                                                                                                                                                                                                                                                                                                                                                                                      async def implement_suggestion(
                                                                                                                                                                                                                                                                                                                                                                                          suggestion_id: int,
                                                                                                                                                                                                                                                                                                                                                                                              db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                              ):
                                                                                                                                                                                                                                                                                                                                                                                                  """
                                                                                                                                                                                                                                                                                                                                                                                                      Mark an AI suggestion as implemented
                                                                                                                                                                                                                                                                                                                                                                                                          """
                                                                                                                                                                                                                                                                                                                                                                                                              suggestion = db.query(AISuggestion).filter(
                                                                                                                                                                                                                                                                                                                                                                                                                      AISuggestion.id == suggestion_id
                                                                                                                                                                                                                                                                                                                                                                                                                          ).first()

                                                                                                                                                                                                                                                                                                                                                                                                                                  if not suggestion:
                                                                                                                                                                                                                                                                                                                                                                                                                                          raise HTTPException(status_code=404, detail="Suggestion not found")

                                                                                                                                                                                                                                                                                                                                                                                                                                                  suggestion.is_implemented = True
                                                                                                                                                                                                                                                                                                                                                                                                                                                      db.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                       # Log activity
                                                                                                                                                                                                                                                                                                                                                                                                                                       #     activity = ActivityLog(
                                                                                                                                                                                                                                                                                                                                                                                                                                               icon="âš¡",
                                                                                                                                                                                                                                                                                                                                                                                                                                                       title="New AI suggestion added for service automation",
                                                                                                                                                                                                                                                                                                                                                                                                                                                               description=suggestion.title,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       category="ai"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               db.add(activity)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   db.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "success": True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "message": "Suggestion implemented"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # ============ WORKFLOWS ENDPOINTS ============

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               @router.get("/workflows")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               async def get_workflows(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           Get all workflows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               For the "Active Workflows" section
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       workflows = db.query(Workflow).all()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "workflows": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "id": w.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "name": w.name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "description": w.description,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "trigger": w.trigger,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "action": w.action,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "icon": w.icon,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "is_active": w.is_active,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "executions_count": len(w.executions)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           for w in workflows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         @router.post("/workflows")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         async def create_workflow(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             workflow: WorkflowCreate,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Create a new workflow
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 new_workflow = Workflow(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         name=workflow.name,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 description=workflow.description,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         trigger=workflow.trigger,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 action=workflow.action,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         icon=workflow.icon,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 is_active=True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         db.add(new_workflow)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             db.commit()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 db.refresh(new_workflow)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         # Log activity
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             activity = ActivityLog(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     icon="âš™ï¸",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             title=f"{workflow.name} workflow created",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     description=f"{workflow.trigger} â†’ {workflow.action}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             category="workflow"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     db.add(activity)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         db.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "success": True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "workflow_id": new_workflow.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                @router.patch("/workflows/{workflow_id}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async def update_workflow(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    workflow_id: int,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        update: WorkflowUpdate,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Update workflow (toggle active/inactive)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            workflow = db.query(Workflow).filter(Workflow.id == workflow_id).first()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not workflow:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise HTTPException(status_code=404, detail="Workflow not found")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    workflow.is_active = update.is_active
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        db.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Log activity
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status = "enabled" if update.is_active else "disabled"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        activity = ActivityLog(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                icon="âš™ï¸",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        title=f"{workflow.name} workflow {status}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                description=f"Status changed to {status}",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        category="workflow"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.add(activity)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "success": True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "workflow_id": workflow_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "is_active": workflow.is_active
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           @router.post("/workflows/{workflow_id}/execute")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           async def execute_workflow(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               workflow_id: int,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   details: Optional[str] = None,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Execute a workflow manually
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       workflow = db.query(Workflow).filter(Workflow.id == workflow_id).first()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if not workflow:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       raise HTTPException(status_code=404, detail="Workflow not found")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if not workflow.is_active:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       raise HTTPException(status_code=400, detail="Workflow is not active")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Create execution record
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   execution = WorkflowExecution(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           workflow_id=workflow_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   status="success",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           details=details or f"Manual execution of {workflow.name}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   db.add(execution)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       db.commit()

@router.post("/workflows/{workflow_id}/execute")
async def execute_workflow(
    workflow_id: int,
        details: Optional[str] = None,
            db: Session = Depends(get_db)
            ):
                """
                    Execute a workflow manually
                        """
                            workflow = db.query(Workflow).filter(Workflow.id == workflow_id).first()
                                
                                    if not workflow:
                                            raise HTTPException(status_code=404, detail="Workflow not found")
                                                
                                                    if not workflow.is_active:
                                                            raise HTTPException(status_code=400, detail="Workflow is not active")
                                                                
                                                                    # Create execution record
                                                                        execution = WorkflowExecution(
                                                                                workflow_id=workflow_id,
                                                                                        status="success",
                                                                                                details=details or f"Manual execution of {workflow.name}"
                                                                                                    )
                                                                                                        db.add(execution)
                                                                                                            db.commit()
                                                                                                        # Log activity
                                                                                                        #     activity = ActivityLog(
                                                                                                                icon="âœ…",
                                                                                                                        title=f"{workflow.name} workflow triggered",
                                                                                                                                description=details or workflow.description,
                                                                                                                                        category="workflow"
                                                                                                                                            )
                                                                                                                                                db.add(activity)
                                                                                                                                                    db.commit()

                                                                                                                                                            return {
                                                                                                                                                                    "success": True,
                                                                                                                                                                            "execution_id": execution.id,
                                                                                                                                                                                    "workflow": workflow.name
                                                                                                                                                                                        }

                                                                                                                                                                                        # ============ ACTIVITY LOG ENDPOINTS ============

                                                                                                                                                                                        @router.get("/activity")
                                                                                                                                                                                        async def get_recent_activity(
                                                                                                                                                                                            limit: int = 20,
                                                                                                                                                                                                db: Session = Depends(get_db)
                                                                                                                                                                                                ):
                                                                                                                                                                                                    """
                                                                                                                                                                                                        Get recent activity logs
                                                                                                                                                                                                            For the "Recent Activity" section
                                                                                                                                                                                                                """
                                                                                                                                                                                                                    activities = db.query(ActivityLog).order_by(
                                                                                                                                                                                                                            ActivityLog.created_at.desc()
                                                                                                                                                                                                                                ).limit(limit).all()

                                                                                                                                                                                                                                        return {
                                                                                                                                                                                                                                                "activities": [
                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                            "id": a.id,
                                                                                                                                                                                                                                                                                            "icon": a.icon,
                                                                                                                                                                                                                                                                                                            "title": a.title,
                                                                                                                                                                                                                                                                                                                            "description": a.description,
                                                                                                                                                                                                                                                                                                                                            "category": a.category,
                                                                                                                                                                                                                                                                                                                                                            "time_ago": get_time_ago(a.created_at)
                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                    for a in activities
                                                                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                @router.post("/activity")
                                                                                                                                                                                                                                                                                                                                                                                                async def create_activity_log(
                                                                                                                                                                                                                                                                                                                                                                                                    activity: ActivityLogCreate,
                                                                                                                                                                                                                                                                                                                                                                                                        db: Session = Depends(get_db)
                                                                                                                                                                                                                                                                                                                                                                                                        ):
                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                Create a new activity log entry
                                                                                                                                                                                                                                                                                                                                                                                                                    """
                                                                                                                                                                                                                                                                                                                                                                                                                        new_activity = ActivityLog(
                                                                                                                                                                                                                                                                                                                                                                                                                                icon=activity.icon,
                                                                                                                                                                                                                                                                                                                                                                                                                                        title=activity.title,
                                                                                                                                                                                                                                                                                                                                                                                                                                                description=activity.description,
                                                                                                                                                                                                                                                                                                                                                                                                                                                        category=activity.category
                                                                                                                                                                                                                                                                                                                                                                                                                                                            )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.add(new_activity)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    db.commit()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "success": True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "activity_id": new_activity.id
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # ============ HELPER FUNCTIONS ============
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 def get_time_ago(timestamp: datetime) -> str:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Convert timestamp to relative time (e.g., "2 min ago")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 now = datetime.utcnow()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     diff = now - timestamp

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             seconds = diff.total_seconds()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if seconds < 60:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return "just now"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 elif seconds < 3600:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         minutes = int(seconds / 60)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return f"{minutes} min ago" if minutes == 1 else f"{minutes} min ago"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     elif seconds < 86400:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             hours = int(seconds / 3600)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return f"{hours} hour ago" if hours == 1 else f"{hours} hours ago"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 days = int(seconds / 86400)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return f"{days} day ago" if days == 1 else f"{days} days ago"   